
<%- insertFragment('imports') %>
<%- insertFragment('init') %>

let moduleExports = function sqlMetadata(app, options) {
  let { convertArgsToFeathers, convertArgsToOrderBy, convertArgsToWhere } = options;
  let makeOrderBy = convertArgsToOrderBy(options);
  let makeWhere = convertArgsToWhere(options);
  <%- insertFragment('func_init') %>

  let returns = {
<%# -%>
<%# --- forEach-1 starts below. Loop thru the schemas of GraphQL enabled services. -%>
<% Object.keys(fieldInfo).forEach(type => { -%>

    <%- type %>: {
      sqlTable: '<%- fieldInfo[type].sqlTable %>',
      uniqueKey: '<%- fieldInfo[type].uniqueKey %>',
      fields: {
<%# -%>
<%# --- forEach-2 starts below. Loop thru the fields to be renamed. -%>
<% Object.keys(fieldInfo[type].sqlColumn).forEach(field => { -%>
        <%- field %>: {
          sqlColumn: '<%- fieldInfo[type].sqlColumn[field] %>',
          <%- insertFragment(`fields-${type}-${field}`) %>
        },
<% }); -%>
<%# --- forEach-2 ends above. -%>
<%# -%>
<%# --- forEach-3 starts below. Loop thru the added fields. -%>
<% Object.keys(fieldInfo[type].fields).forEach(field => { -%>

        // <%- field %><%- fieldInfo[type].fields[field].args %>: <%- fieldInfo[type].fields[field].type %>
        <%- field %>: {
<%# -%>
<%# --- if/else-1 starts below. -%>
<% if (fieldInfo[type].fields[field].serviceName) {
    __fieldInfoField = fieldInfo[type].fields[field];
    __relationOtherTableSql = fieldInfo[__fieldInfoField.typeName]
        && fieldInfo[__fieldInfoField.typeName].sqlColumn[__fieldInfoField.relationOtherTable]
            ? fieldInfo[__fieldInfoField.typeName].sqlColumn[__fieldInfoField.relationOtherTable]
            : __fieldInfoField.relationOtherTable;
    __temp = [
        '          sqlJoin(ourTable, otherTable) { return `${ourTable}.'
            + __fieldInfoField.relationOurTableSql
            + ' = ${otherTable}.'
            + __relationOtherTableSql
            + '`; },',
        '          orderBy(args, content) { return makeOrderBy(args, null); },',
        `          where(table, args) { return makeWhere(table, args, '${__fieldInfoField.relationOurTableSql}', undefined); },`,
    ];
-%>
          <%- insertFragment(`fields-${type}-${field}`, __temp) %>
<% } else { -%>
          <%- insertFragment(`fields-${type}-${field}-non`, [
            '          sqlExpr: (tableName, args) => { throw Error(\'GraphQL field ${type}.${field} is not calculated.\'); },',
]) %>
<%# --- if/else-1 ends above. -%>
<% } -%>
<%# --- forEach-3 ends above. -%>
        },
<% }); -%>
<%# --- forEach-1 ends above. -%>
        <%- insertFragment(`fields-${type}`) %>
      },
      <%- insertFragment(`type-${type}`) %>
    },
<% }); -%>

    Query: {
      fields: {
<%# -%>
<%# --- forEach-4 starts below. Loop thru the schemas of GraphQL enabled services. -%>
<% Object.keys(queryInfo).forEach(graphqlName => {
    __uniqueKey = queryInfo[graphqlName].uniqueKey;
    __temp = [
        `        // get${graphqlName}(query: JSON, params: JSON, key: JSON): ${graphqlName}`,
        `        get${graphqlName}: {`,
        `          orderBy: (args, content) => makeOrderBy(args, { ${__uniqueKey} : 1 }),`,
        `          where: (table, args) => makeWhere(table, args, '${__uniqueKey}'),`,
        '        },',
        '',
        `        // find${graphqlName}(query: JSON, params: JSON): [${graphqlName}!]`,
        `        find${graphqlName}: {`,
        `          orderBy: (args, content) => makeOrderBy(args, { ${__uniqueKey} : 1 }),`,
        `          where: (table, args) => makeWhere(table, args, '${__uniqueKey}'),`,
        '        },',
    ];
-%>

        <%- insertFragment(`query-${graphqlName}`, __temp) %>
<% }); -%>
<%# --- forEach-4 ends above. -%>
        <%- insertFragment('metadata_query_fields') %>
      },
      <%- insertFragment('metadata_query_more') %>
    },
  <%- insertFragment('metadata_more') %>
  };

//!code: func_return //!end
return returns;
};

<%- insertFragment('more') %>

<%- insertFragment('exports') %>
module.exports = moduleExports;

<%- insertFragment('funcs') %>
<%- insertFragment('end') %>
