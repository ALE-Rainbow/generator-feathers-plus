
<%- insertFragment('imports') %>
<%- insertFragment('init') %>

let moduleExports = function sqlMetadata(app, options) {
  let { convertArgsToFeathers, convertArgsToOrderBy, convertArgsToWhere } = options;
  let makeOrderBy = convertArgsToOrderBy(options);
  let makeWhere = convertArgsToWhere(options);
  <%- insertFragment('func_init') %>

  let returns = {
<%# -%>
<%# --- forEach-1 starts below. Loop thru the schemas of GraphQL enabled services. -%>
<% Object.keys(serviceFieldResolvers).forEach(type => { -%>

    <%- type %>: {
      sqlTable: '<%- serviceFieldResolvers[type].sqlTable %>',
      uniqueKey: '<%- serviceFieldResolvers[type].uniqueKey %>',
      fields: {
<%# -%>
<%# --- forEach-2 starts below. Loop thru the fields to be renamed. -%>
<% Object.keys(serviceFieldResolvers[type].sqlColumn).forEach(field => { -%>
        <%- field %>: {
          sqlColumn: '<%- serviceFieldResolvers[type].sqlColumn[field] %>',
          <%- insertFragment(`fields-${type}-${field}`) %>
        },
<% }); -%>
<%# --- forEach-2 ends above. -%>
<%# -%>
<%# --- forEach-3 starts below. Loop thru the added fields. -%>
<% Object.keys(serviceFieldResolvers[type].fields).forEach(field => { -%>

        // <%- field %><%- serviceFieldResolvers[type].fields[field].args %>: <%- serviceFieldResolvers[type].fields[field].type %>
        <%- field %>: {
<%# -%>
<%# --- if/else-1 starts below. -%>
<% if (serviceFieldResolvers[type].fields[field].serviceName) {
          __temp = [
            '          sqlJoin(ourTable, otherTable) { return \'ourTable.__XXX__ = otherTable.BAR\'; },',
            '          orderBy(args, content) { return makeOrderBy(args, null); },',
            '          where(table, args) { return makeWhere(table, args, \'__ZZZ__\', undefined); },',
          ];
-%>
          <%- insertFragment(`fields-${type}-${field}`, __temp) %>
<% } else { -%>
          <%- insertFragment(`fields-${type}-${field}-non`, [
            '          sqlExpr: (tableName, args) => `${tableName}.__XXX__ || \' \' || ${tableName}.__YYY__`',
]) %>
<%# --- if/else-1 ends above. -%>
<% } -%>
<%# --- forEach-3 ends above. -%>
        },
<% }); -%>
<%# --- forEach-1 ends above. -%>
        <%- insertFragment(`fields-${type}`) %>
      },
      <%- insertFragment(`type-${type}`) %>
    },
<% }); -%>

    Query: {
      fields: {
<%# -%>
<%# --- forEach-4 starts below. Loop thru the schemas of GraphQL enabled services. -%>
<% Object.keys(queryResolvers).forEach(graphqlName => {
      __temp = [
        `        // get${graphqlName}(query: JSON, params: JSON, key: JSON): ${graphqlName}`,
        `        get${graphqlName}: {`,
        '          orderBy: (args, content) => makeOrderBy(args, {}),',
        `          where: (table, args) => makeWhere(table, args, '__XXX__'),`,
        '        },',
        '',
        `        // find${graphqlName}(query: JSON, params: JSON): [${graphqlName}!]`,
        `        find${graphqlName}: {`,
        `          orderBy: (args, content) => makeOrderBy(args, {}),`,
        `          where: (table, args) => makeWhere(table, args, '__XXX__'),`,
        '        },',
      ];
-%>

        <%- insertFragment(`query-${graphqlName}`, __temp) %>
<% }); -%>
<%# --- forEach-4 ends above. -%>
        <%- insertFragment('metadata_query_fields') %>
      },
      <%- insertFragment('metadata_query_more') %>
    },
  <%- insertFragment('metadata_more') %>
  };

//!code: func_return //!end
return returns;
};

<%- insertFragment('more') %>

<%- insertFragment('exports') %>
module.exports = moduleExports;

<%- insertFragment('funcs') %>
<%- insertFragment('end') %>
