
// Execute raw SQL statement for GraphQL using Knex. (Can be re-generated.)
<%- tplTsOnly([`import { App } from '../../app.interface'${sc}`, '']) -%>
<%- tplTsOnly([`import { Knex } from 'knex'${sc}`, '']) -%>
<%- tplImports('{ getByDot }', 'feathers-hooks-common') %>
<%- insertFragment('imports') %>

let dialects<%- tplTsOnly(': any') -%> = {
  mysql: 'mysql',
  sqlite: 'sqlite3',
  postgres: 'pg'
}<%- sc %>
<%- insertFragment('init') %>

<%- tplModuleExports(null, 'function sqlExecuteKnex(app) {', 'function sqlExecuteKnex(app: App) {') %>
  let generatorSpecs = app.get('generatorSpecs')<%- sc %>
  let knex = app.get('knexClient')<%- tplTsOnly([' as Knex']) -%><%- sc %>
  let database = getByDot(generatorSpecs, 'connections.knex.database')<%- sc %>
  let dialect = dialects[database]<%- sc %>
  <%- insertFragment('func_init') %>

  if (!knex) {
    throw new Error('No knex client')<%- sc %>
  }
  if (!dialect) {
    throw new Error(`Unsupported dialect: '${dialect}'`)<%- sc %>
  }

  let executeSql = <%- tplJsOrTs('sql', '(sql: string)') %> => knex.raw(sql)
    .catch(<%- tplJsOrTs('err', '(err: Error)') %> => {
      // <%- lintDisableNextLine %> no-console
      console.log('executeSql error=', err.message)<%- sc %>
      throw err<%- sc %>
    })<%- sc %>

  let returns = {
    dialect,
    executeSql,
    openDb: undefined
    <%- insertFragment('moduleExports') %>
  }<%- sc %>

  <%- insertFragment('func_return') %>
  return returns<%- sc %>
}<%- sc %>
<%- insertFragment('more') %>

<%- insertFragment('exports') %>
<%- `${tplExport('moduleExports')}${sc}` %>

<%- insertFragment('funcs') %>
<%- insertFragment('end') %>
